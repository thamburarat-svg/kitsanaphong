
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดพฤติกรรมผู้บริโภค</title>
    <!-- ใช้ Tailwind CSS สำหรับการจัดสไตล์ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ใช้ Chart.js สำหรับการสร้างกราฟ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            @apply bg-white p-6 rounded-2xl shadow-lg;
        }
        .data-table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            @apply px-4 py-2 text-left border-b border-gray-200;
        }
        .data-table th {
            @apply bg-gray-50 sticky top-0 font-semibold text-gray-700 uppercase;
        }
        .data-table tbody tr:hover {
            @apply bg-gray-100;
        }
        .loading-text {
            @apply text-center text-gray-500 text-lg mt-8;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-6 text-center">
            แดชบอร์ดพฤติกรรมผู้บริโภค
        </h1>

        <!-- ส่วนของ Card แสดงข้อมูลสรุป -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card transform hover:scale-105 transition-transform duration-300">
                <h2 class="text-xl font-semibold text-gray-600">จำนวนผู้ใช้งานทั้งหมด</h2>
                <p id="total-users" class="text-5xl font-bold text-indigo-600 mt-2">...</p>
            </div>
            <div class="card transform hover:scale-105 transition-transform duration-300">
                <h2 class="text-xl font-semibold text-gray-600">คะแนนความพึงพอใจเฉลี่ย</h2>
                <p id="avg-satisfaction" class="text-5xl font-bold text-green-600 mt-2">...</p>
            </div>
        </div>

        <!-- ส่วนของกราฟแท่ง -->
        <div class="card mb-8">
            <h2 class="text-xl font-semibold text-gray-600 mb-4">จำนวนผู้ใช้งานในแต่ละแพลตฟอร์ม</h2>
            <div class="relative h-96">
                <canvas id="platform-chart"></canvas>
            </div>
        </div>

        <!-- ส่วนของตารางข้อมูล -->
        <div class="card">
            <h2 class="text-xl font-semibold text-gray-600 mb-4">ข้อมูลลูกค้าทั้งหมด</h2>
            <!-- แถบควบคุมการกรองข้อมูล -->
            <div class="flex flex-col md:flex-row items-center gap-4 mb-4">
                <input type="text" id="searchInput" placeholder="ค้นหา..." class="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <select id="genderFilter" class="w-full md:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">กรองตามเพศ</option>
                    <option value="Male">ชาย</option>
                    <option value="Female">หญิง</option>
                </select>
                <select id="incomeFilter" class="w-full md:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">กรองตามรายได้</option>
                    <option value="Low">ต่ำ</option>
                    <option value="Medium">ปานกลาง</option>
                    <option value="High">สูง</option>
                </select>
            </div>

            <div class="data-table-container rounded-lg shadow-inner">
                <p id="loadingMessage" class="loading-text">กำลังโหลดข้อมูล... โปรดรอสักครู่</p>
                <table id="dataTable" class="data-table hidden">
                    <thead>
                        <tr>
                            <th class="cursor-pointer">ID</th>
                            <th class="cursor-pointer">อายุ</th>
                            <th class="cursor-pointer">เพศ</th>
                            <th class="cursor-pointer">ระดับรายได้</th>
                            <th class="cursor-pointer">การศึกษา</th>
                            <th class="cursor-pointer">ที่ตั้ง</th>
                            <th class="cursor-pointer">แพลตฟอร์มที่ชอบ</th>
                            <th class="cursor-pointer">คะแนนความพึงพอใจ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ข้อมูลจะถูกสร้างขึ้นด้วย JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // URL ของไฟล์ CSV จาก Google Sheets
        const dataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSYQby6nNzcAlvyJhxp6SjGtjpatGe3vFkI1de94YReEmGImoMPv3OCR8Fymb20jL8q3ObIyKFcYeBA/pub?gid=0&single=true&output=csv';

        let data = [];
        let filteredData = [];
        let platformChart = null;

        // ฟังก์ชันสำหรับดึงข้อมูลและอัปเดตแดชบอร์ด
        async function fetchAndRenderDashboard() {
            const loadingMessage = document.getElementById('loadingMessage');
            const dataTable = document.getElementById('dataTable');

            try {
                // แสดงข้อความกำลังโหลด
                loadingMessage.classList.remove('hidden');
                dataTable.classList.add('hidden');

                const response = await fetch(dataUrl);
                const csvText = await response.text();

                data = parseCsv(csvText);
                filteredData = data;

                // ซ่อนข้อความกำลังโหลดและแสดงตาราง
                loadingMessage.classList.add('hidden');
                dataTable.classList.remove('hidden');

                updateCards(data);
                updateChart(data);
                renderTable(data);

            } catch (error) {
                console.error("Error fetching or parsing data:", error);
                loadingMessage.textContent = 'ไม่สามารถโหลดข้อมูลได้ โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ต';
                loadingMessage.classList.remove('hidden');
            }
        }

        // ฟังก์ชันสำหรับอัปเดต Card ข้อมูล
        function updateCards(data) {
            const totalUsersEl = document.getElementById('total-users');
            const avgSatisfactionEl = document.getElementById('avg-satisfaction');

            totalUsersEl.textContent = data.length;
            const avgSatisfaction = data.reduce((sum, row) => sum + parseFloat(row.satisfaction_score), 0) / data.length;
            avgSatisfactionEl.textContent = avgSatisfaction.toFixed(2);
        }

        // ฟังก์ชันสำหรับอัปเดตกราฟ
        function updateChart(data) {
            const platformCounts = data.reduce((acc, row) => {
                acc[row.preferred_platform] = (acc[row.preferred_platform] || 0) + 1;
                return acc;
            }, {});

            const platformLabels = Object.keys(platformCounts);
            const platformValues = Object.values(platformCounts);

            if (platformChart) {
                platformChart.destroy();
            }

            const ctx = document.getElementById('platform-chart').getContext('2d');
            platformChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: platformLabels,
                    datasets: [{
                        label: 'จำนวนผู้ใช้งาน',
                        data: platformValues,
                        backgroundColor: [
                            '#6366f1', '#a855f7', '#ec4899', '#f97316', '#eab308'
                        ],
                        borderColor: [
                            '#4338ca', '#7e22ce', '#be185d', '#c2410c', '#a16207'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'จำนวนผู้ใช้งาน'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'แพลตฟอร์ม'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // ฟังก์ชันสำหรับสร้างตาราง
        function renderTable(dataToRender) {
            const dataTableBody = document.querySelector('#dataTable tbody');
            dataTableBody.innerHTML = '';
            if (dataToRender.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="8" class="text-center py-4 text-gray-500">ไม่พบข้อมูล</td>`;
                dataTableBody.appendChild(row);
                return;
            }
            dataToRender.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="whitespace-nowrap">${row.customer_id}</td>
                    <td class="whitespace-nowrap">${row.age}</td>
                    <td class="whitespace-nowrap">${row.gender}</td>
                    <td class="whitespace-nowrap">${row.income_level}</td>
                    <td class="whitespace-nowrap">${row.education}</td>
                    <td class="whitespace-nowrap">${row.location}</td>
                    <td class="whitespace-nowrap">${row.preferred_platform}</td>
                    <td class="whitespace-nowrap">${row.satisfaction_score}</td>
                `;
                dataTableBody.appendChild(tr);
            });
        }

        // ฟังก์ชันสำหรับกรองข้อมูล
        function applyFilters() {
            const searchInput = document.getElementById('searchInput');
            const genderFilter = document.getElementById('genderFilter');
            const incomeFilter = document.getElementById('incomeFilter');
            const searchTerm = searchInput.value.toLowerCase();
            const gender = genderFilter.value;
            const income = incomeFilter.value;

            filteredData = data.filter(row => {
                const matchesSearch = Object.values(row).some(value =>
                    String(value).toLowerCase().includes(searchTerm)
                );
                const matchesGender = gender === '' || row.gender === gender;
                const matchesIncome = income === '' || row.income_level === income;
                return matchesSearch && matchesGender && matchesIncome;
            });
            renderTable(filteredData);
        }

        // ฟังก์ชันสำหรับแปลง CSV string เป็น Array of Objects
        function parseCsv(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.trim());
            const data = lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, index) => {
                    obj[header] = values[index].trim();
                    return obj;
                }, {});
            });
            return data;
        }

        // เพิ่ม Event Listener เมื่อ DOM โหลดเสร็จ
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const genderFilter = document.getElementById('genderFilter');
            const incomeFilter = document.getElementById('incomeFilter');
            const headers = document.querySelectorAll('#dataTable th');
            let sortDirection = {};

            // เพิ่ม Event Listener สำหรับการกรอง
            searchInput.addEventListener('input', applyFilters);
            genderFilter.addEventListener('change', applyFilters);
            incomeFilter.addEventListener('change', applyFilters);

            // เพิ่ม Event Listener สำหรับการเรียงลำดับ
            headers.forEach((header) => {
                header.addEventListener('click', () => {
                    const key = header.textContent.trim().toLowerCase().replace(/ /g, '_');
                    if (sortDirection[key] === 'asc') {
                        filteredData.sort((a, b) => (String(b[key]) > String(a[key]) ? 1 : -1));
                        sortDirection[key] = 'desc';
                    } else {
                        filteredData.sort((a, b) => (String(a[key]) > String(b[key]) ? 1 : -1));
                        sortDirection[key] = 'asc';
                    }
                    renderTable(filteredData);
                });
            });

            // เริ่มต้นการโหลดข้อมูลเมื่อหน้าเว็บเปิด
            fetchAndRenderDashboard();
        });
    </script>
</body>
</html>
